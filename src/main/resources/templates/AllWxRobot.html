<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>统计</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #e0e7ff 0%, #f0f2f5 100%);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 90%;
            text-align: center;
            margin: 0 auto;
        }

        h1 {
            color: #2c3e50;
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .input-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        select, input[type="number"] {
            padding: 0.75rem;
            font-size: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            width: 10rem;
            background-color: #f9fafb;
        }

        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="gray" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        button {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            background-color: #34d399;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            -webkit-tap-highlight-color: transparent;
        }

        button:active {
            transform: scale(0.95);
        }

        button:hover {
            background-color: #2cc0a0;
        }

        #copyButton {
            background-color: #3b82f6;
            margin-top: 1rem;
        }

        #copyButton:hover {
            background-color: #2563eb;
        }

        #result {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 10px;
            text-align: left;
            white-space: pre-wrap;
            font-size: 1rem;
            line-height: 1.5;
            max-height: 60vh;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            margin-top: 1rem;
            -webkit-overflow-scrolling: touch;
        }

        .error {
            color: #ef4444;
            font-size: 0.9rem;
            margin-top: 0.75rem;
        }

        #copyArea {
            position: absolute;
            top: -9999px;
            left: -9999px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
                max-width: 95%;
            }

            h1 {
                font-size: 1.5rem;
            }

            select, input[type="number"] {
                width: 8rem;
                font-size: 0.9rem;
                padding: 0.6rem;
            }

            button {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }

            #result {
                font-size: 0.9rem;
                max-height: 50vh;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>统计</h1>
    <div class="input-group">
        <select id="wxRoomId">
            <option value="7940" selected>书棋</option>
            <option value="7938">书月</option>
            <option value="7939">书画</option>
            <option value="7941">书柠</option>
            <option value="7942">书屿</option>
            <option value="7943">诗意</option>
            <option value="7953">书栀</option>
            <option value="7980">书聆</option>
        </select>
        <select id="activeType">
            <option value="1" selected>日活跃</option>
            <option value="2">月活跃</option>
            <option value="3">金币</option>
            <option value="4">魅力</option>
        </select>
        <input type="number" id="topNInput" min="1" max="250" value="10" style="display: none;" placeholder="显示前N名">
        <button id="fetchButton">查询</button>
    </div>
    <div id="result">请选择类型以查询数据</div>
    <button id="copyButton" onclick="copyToClipboard()" style="display: none;">一键复制</button>
    <div id="error" class="error"></div>
</div>
<textarea id="copyArea"></textarea>

<script>

    function formatChineseNumber(number) {
        const num = Number(number);
        const absNum = Math.abs(num);
        let suffix = '';
        let divisor = 1;

        // Determine unit and divisor
        if (absNum >= 100000000) {
            divisor = 100000000;
            suffix = '亿';
        } else if (absNum >= 10000) {
            divisor = 10000;
            suffix = '万';
        }

        // If unit conversion is needed
        if (suffix) {
            // Divide and truncate to 2 decimal places without rounding
            const value = Math.floor((num / divisor) * 100) / 100;
            // Convert to string and remove trailing zeros
            const formatted = value.toFixed(2).replace(/\.?0+$/, '');
            return formatted + suffix;
        }

        // Return original number if less than 10,000
        return num.toString();
    }

    const activeTypeSelect = document.getElementById('activeType');
    const topNInput = document.getElementById('topNInput');

    // Show/hide topN input based on activeType
    activeTypeSelect.addEventListener('change', () => {
        const activeType = activeTypeSelect.value;
        topNInput.style.display = (activeType === '3' || activeType === '4') ? 'block' : 'none';
    });

    // Initialize visibility
    topNInput.style.display = 'none';

    document.getElementById('fetchButton').addEventListener('click', async () => {
        const resultElement = document.getElementById('result');
        const errorElement = document.getElementById('error');
        const copyButton = document.getElementById('copyButton');
        resultElement.textContent = '正在请求数据...';
        errorElement.textContent = '';
        copyButton.style.display = 'none';

        try {
            const wxRoomId = document.getElementById('wxRoomId').value;
            const activeType = activeTypeSelect.value;
            let topN = parseInt(topNInput.value, 10);
            if (isNaN(topN) || topN < 1) topN = 10; // Default to 10 if invalid
            if (topN > 250) topN = 250; // Cap at pageSize

            // Configuration for filtering, sorting, and formatting
            const typeConfig = {
                1: {
                    key: 'msgCount',
                    min: 100,
                    topN: Infinity,
                    format: (item, index) => `${index + 1} 【${item.msgCount}】 ${item.nickName}`
                },
                2: {
                    key: 'monthMsgCount',
                    min: 3000,
                    topN: Infinity,
                    format: (item, index) => {
                        const value = Math.floor(item.monthMsgCount / 8888);
                        return `${index + 1} 【${item.monthMsgCount}】 ${item.nickName}  ${value > 0 ? '' + (value * 33.44).toFixed(2) + ' 元' : ''}`;
                    }
                },
                3: {
                    key: 'corn',
                    min: 1,
                    topN: topN,
                    format: (item, index) => `${index + 1} 【${formatChineseNumber(item.corn)}】 ${item.nickName}`
                },
                4: {
                    key: 'charm',
                    min: 1,
                    topN: topN,
                    format: (item, index) => `${index + 1} 【${formatChineseNumber(item.charm)}】 ${item.nickName}`
                }
            };

            // Step 1: Fetch cookie via proxy
            await fetch(`https://space.robotcy.cn:18082/mini_api/wxRoom/selectRoom?wxRoomId=${wxRoomId}`);

            // Step 2: Send POST request
            const postData = {
                pageSize: 250,
                pageNum: 1,
                wxRoomId: wxRoomId,
                type: 10,
                hytype: activeType
            };

            const response = await fetch('https://space.robotcy.cn:18082/mini_api/wxRoom/selectRoomUser', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(postData)
            });

            const data = await response.json();
            if (!data.data?.list) {
                throw new Error('数据格式错误或无数据');
            }

            // Filter, sort, and limit data
            const config = typeConfig[activeType];
            data.data.list = data.data.list
                .filter(item => item[config.key] >= config.min)
                .sort((a, b) => b[config.key] - a[config.key])
                .slice(0, config.topN);

            // Format result
            let result = '';
            data.data.list.forEach((item, index) => {
                result += config.format(item, index) + '\n';
            });

            // Update UI
            resultElement.textContent = result || '暂无数据';
            copyButton.style.display = result ? 'block' : 'none';
        } catch (error) {
            errorElement.textContent = `错误: ${error.message}`;
            resultElement.textContent = '查询失败，请重试';
        }
    });

    function copyToClipboard() {
        const resultDiv = document.getElementById('result');
        const text = resultDiv.textContent;

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                alert('已复制到剪贴板！');
            }).catch(err => {
                console.error('Clipboard API 复制失败：', err);
                fallbackCopyToClipboard(text);
            });
        } else {
            fallbackCopyToClipboard(text);
        }
    }

    function fallbackCopyToClipboard(text) {
        const copyArea = document.getElementById('copyArea');
        copyArea.value = text;
        copyArea.select();
        try {
            const successful = document.execCommand('copy');
            alert(successful ? '已复制到剪贴板！' : '复制失败，请手动复制！');
        } catch (err) {
            console.error('备用复制方案失败：', err);
            alert('复制失败，请手动复制！');
        }
    }
</script>
</body>
</html>